generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  COACH
  CLIENT
  ADMIN
}

enum MessageSender {
  COACH
  CLIENT
}

enum NotificationType {
  NUDGE
  GENERAL
  SYSTEM
}

enum TemplateVisibility {
  PRIVATE
  TEAM
  PUBLIC
}

enum WorkoutRole {
  FULL_BODY
  UPPER
  LOWER
  CARDIO
  HIIT
  RECOVERY
  CORE
  CUSTOM
}

enum WorkoutGoal {
  STRENGTH
  HYPERTROPHY
  FAT_LOSS
  GENERAL_FITNESS
  ENDURANCE
  MOBILITY
}

enum WorkoutDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum TrainingEnvironment {
  GYM
  HOME
  BODYWEIGHT
  OUTDOOR
}

enum SessionType {
  STRENGTH
  CIRCUIT
  HIIT
  MOBILITY
  RECOVERY
}

enum BlockType {
  STANDARD_SETS_REPS
  CIRCUIT
  AMRAP
  EMOM
  HIIT_INTERVAL
  CUSTOM
}

enum SessionStatus {
  IN_PROGRESS
  COMPLETED
  ABORTED
}

enum FeelingCode {
  TOO_EASY
  GOOD_CHALLENGE
  HARD
  FAILED_REPS
  PAIN
}

enum AuthProvider {
  EMAIL
  GOOGLE
  APPLE
  PHONE
}

enum TemporaryCodeType {
  TRIAL_CODE
  COACH_INVITE
  CORPORATE_WELLNESS
}

enum SubscriptionTier {
  FREE
  PREMIUM_MONTHLY
  PREMIUM_ANNUAL
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
  UNPAID
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

// ============================================
// AUTHENTICATION & USER MANAGEMENT
// ============================================

model User {
  id       String  @id @default(cuid())
  email    String? @unique
  phone    String? @unique
  name     String?
  role     Role    @default(CLIENT)
  password String? // Nullable for OAuth users

  // Authentication
  authProvider  AuthProvider @default(EMAIL)
  googleId      String?      @unique
  appleId       String?      @unique
  phoneVerified Boolean      @default(false)
  emailVerified Boolean      @default(false)

  // Trial & Subscription
  trialStart           DateTime?
  trialEnd             DateTime?
  subscriptionTier     SubscriptionTier   @default(FREE)
  subscriptionStatus   SubscriptionStatus @default(ACTIVE)
  stripeCustomerId     String?            @unique
  stripeSubscriptionId String?            @unique

  // Profile
  client   Client?      @relation(fields: [clientId], references: [id])
  clientId String?      @unique
  profile  UserProfile?

  // Relations
  coachedClients        Client[]                  @relation("CoachClients")
  sentMessages          ChatMessage[]             @relation("CoachMessages")
  notificationsSent     Notification[]            @relation("CoachNotifications")
  programs              Program[]                 @relation("ProgramCoach")
  workouts              Workout[]                 @relation("WorkoutCoach")
  coachNotes            CoachNote[]               @relation("CoachNotes")
  templates             ProgramTemplate[]
  teamsOwned            Team[]                    @relation("TeamOwner")
  teamMemberships       TeamMember[]
  subscriptions         Subscription[]
  payments              Payment[]
  workoutLogs           WorkoutLog[]
  workoutSessions       WorkoutSession[]          @relation("WorkoutSessionClient")
  progressPhotos        ProgressPhoto[]
  bodyMeasurements      BodyMeasurement[]
  mealPlans             MealPlan[]
  coachAssignments      CoachAssignment[]         @relation("CoachAssignments")
  clientAssignments     CoachAssignment[]         @relation("ClientAssignments")
  temporaryCodes        TemporaryCode[]
  redeemedCodes         TemporaryCodeRedemption[]
  groupMemberships      GroupMember[]
  challengeParticipants ChallengeParticipant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserProfile {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique

  avatar          String?
  dateOfBirth     DateTime?
  gender          String?
  height          Float? // in cm
  weight          Float? // in kg
  fitnessGoal     String?
  experienceLevel String?
  timezone        String    @default("UTC")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// TEMPORARY ACCESS CODES
// ============================================

model TemporaryCode {
  id           String            @id @default(cuid())
  code         String            @unique
  type         TemporaryCodeType
  expiresAt    DateTime
  maxUses      Int               @default(1)
  usedCount    Int               @default(0)
  assignedTier SubscriptionTier  @default(PREMIUM_MONTHLY)
  trialDays    Int? // If type is TRIAL_CODE

  createdBy   User?   @relation(fields: [createdById], references: [id])
  createdById String?

  redemptions TemporaryCodeRedemption[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TemporaryCodeRedemption {
  id     String        @id @default(cuid())
  code   TemporaryCode @relation(fields: [codeId], references: [id])
  codeId String
  user   User          @relation(fields: [userId], references: [id])
  userId String

  createdAt DateTime @default(now())

  @@unique([codeId, userId])
  @@index([userId])
}

// ============================================
// SUBSCRIPTIONS & PAYMENTS
// ============================================

model Subscription {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String

  tier                 SubscriptionTier
  status               SubscriptionStatus
  stripeSubscriptionId String?            @unique
  stripePriceId        String?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)

  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Payment {
  id             String        @id @default(cuid())
  user           User          @relation(fields: [userId], references: [id])
  userId         String
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])
  subscriptionId String?

  amount                Int // in cents
  currency              String        @default("usd")
  status                PaymentStatus
  stripePaymentIntentId String?       @unique
  stripeInvoiceId       String?

  createdAt DateTime @default(now())

  @@index([userId])
}

// ============================================
// EXISTING MODELS (Updated)
// ============================================

model Client {
  id    String  @id @default(cuid())
  name  String
  email String? @unique

  user   User?   @relation
  userId String? @unique

  coach   User?   @relation("CoachClients", fields: [coachId], references: [id])
  coachId String?

  currentProgram   Program? @relation(fields: [currentProgramId], references: [id])
  currentProgramId String?

  programStartDate DateTime?

  logs          CompletionLog[]
  gamification  GamificationProfile?
  preferredLang String               @default("en")

  messages      ChatMessage[]  @relation("ClientMessages")
  notes         CoachNote[]
  notifications Notification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Program {
  id      String  @id @default(cuid())
  name    String
  goal    String?
  coach   User?   @relation("ProgramCoach", fields: [coachId], references: [id])
  coachId String?

  clients  Client[]
  workouts Workout[]
  days     ProgramDay[]
  weeks    ProgramWeek[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProgramWeek {
  id         String  @id @default(cuid())
  program    Program @relation(fields: [programId], references: [id])
  programId  String
  weekNumber Int
  title      String?
  notes      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([programId, weekNumber])
}

model Workout {
  id          String  @id @default(cuid())
  name        String
  description String?
  videoUrl    String?
  coach       User?   @relation("WorkoutCoach", fields: [coachId], references: [id])
  coachId     String?

  program   Program? @relation(fields: [programId], references: [id])
  programId String?

  // New metadata fields
  goal                WorkoutGoal?
  difficulty          WorkoutDifficulty?
  trainingEnvironment TrainingEnvironment?
  primaryBodyFocus    String?
  estimatedDuration   Int? // in minutes
  sessionTypes        SessionType[]
  tags                String[]
  visibility          TemplateVisibility   @default(PRIVATE)
  usageCount          Int                  @default(0)

  sections    WorkoutSection[]
  exercises   Exercise[]
  programDays ProgramDay[]
  logs        WorkoutLog[]
  sessions    WorkoutSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WorkoutSection {
  id        String  @id @default(cuid())
  workout   Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  workoutId String
  name      String  @default("Section")
  order     Int
  notes     String?

  blocks WorkoutBlock[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workoutId, order])
}

model WorkoutBlock {
  id                String         @id @default(cuid())
  section           WorkoutSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  sectionId         String
  type              BlockType
  title             String?
  instructions      String?
  rounds            Int?
  restBetweenRounds Int? // in seconds
  estimatedTime     Int? // in seconds
  order             Int

  exercises WorkoutExercise[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sectionId, order])
}

model WorkoutExercise {
  id         String       @id @default(cuid())
  block      WorkoutBlock @relation(fields: [blockId], references: [id], onDelete: Cascade)
  blockId    String
  exercise   Exercise?    @relation(fields: [exerciseId], references: [id])
  exerciseId String?

  // Custom exercise fields (if not from library)
  name            String
  category        String?
  equipment       String?
  musclesTargeted String[]
  notes           String? // Client-facing cues
  coachNotes      String? // Private coach notes

  // Per-set programming (JSON arrays for flexibility)
  targetRepsBySet      Json // [8, 8, 8]
  targetWeightBySet    Json? // [50, 50, 50] or null
  targetRestBySet      Json? // [60, 60, 90]
  targetRPEBySet       Json? // [7, 7, 8]
  loadPrescriptionType String? // "exact", "percent_1rm", "rpe"

  order Int

  setLogs ExerciseSetLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([blockId, order])
}

model Exercise {
  id              String   @id @default(cuid())
  workout         Workout? @relation(fields: [workoutId], references: [id])
  workoutId       String?
  name            String
  sets            Int
  reps            Int?
  durationSeconds Int?
  restSeconds     Int?
  weight          Float? // Default weight
  notes           String?
  videoUrl        String?
  canSwap         Boolean  @default(false) // Allow exercise swap

  // Exercise library fields
  category          String?
  equipment         String?
  musclesTargeted   String[]
  isLibraryExercise Boolean  @default(false)

  workoutExercises WorkoutExercise[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProgramDay {
  id        String   @id @default(cuid())
  program   Program  @relation(fields: [programId], references: [id])
  programId String
  dayIndex  Int
  title     String
  workout   Workout? @relation(fields: [workoutId], references: [id])
  workoutId String?
  isRestDay Boolean  @default(false)
  notes     String?

  sessions WorkoutSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([programId, dayIndex])
}

// ============================================
// TRACKING
// ============================================

model WorkoutSession {
  id           String      @id @default(cuid())
  client       User        @relation("WorkoutSessionClient", fields: [clientId], references: [id])
  clientId     String
  workout      Workout     @relation(fields: [workoutId], references: [id])
  workoutId    String
  programDay   ProgramDay? @relation(fields: [programDayId], references: [id])
  programDayId String?

  dateTimeStarted   DateTime
  dateTimeCompleted DateTime?
  status            SessionStatus @default(IN_PROGRESS)
  clientNotes       String?
  coachNotes        String?

  setLogs ExerciseSetLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId, dateTimeStarted])
}

model ExerciseSetLog {
  id                String          @id @default(cuid())
  session           WorkoutSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId         String
  workoutExercise   WorkoutExercise @relation(fields: [workoutExerciseId], references: [id])
  workoutExerciseId String

  exerciseId   String? // Reference to Exercise library if applicable
  exerciseName String // Denormalized for display
  setNumber    Int

  // Prescribed values
  targetReps   Int
  targetWeight Float?
  targetUnit   String @default("kg")

  // Client logged values
  actualReps   Int?
  actualWeight Float?
  actualUnit   String @default("kg")

  // Feeling
  feelingCode  FeelingCode?
  feelingEmoji String?
  feelingNote  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, workoutExerciseId, setNumber])
}

// Legacy model - kept for backward compatibility
model WorkoutLog {
  id        String  @id @default(cuid())
  user      User    @relation(fields: [userId], references: [id])
  userId    String
  workout   Workout @relation(fields: [workoutId], references: [id])
  workoutId String

  date      DateTime @default(now())
  completed Boolean  @default(true)
  duration  Int? // in seconds
  notes     String?

  exerciseLogs ExerciseLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, date])
}

model ExerciseLog {
  id           String     @id @default(cuid())
  workoutLog   WorkoutLog @relation(fields: [workoutLogId], references: [id], onDelete: Cascade)
  workoutLogId String

  exerciseName String
  sets         Int
  reps         Int?
  weight       Float?
  duration     Int? // in seconds
  restSeconds  Int?
  notes        String?

  createdAt DateTime @default(now())
}

model ProgressPhoto {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String

  photoUrl  String // Cloud storage URL
  photoType String // front, side, back
  date      DateTime @default(now())
  notes     String?

  createdAt DateTime @default(now())

  @@index([userId, date])
}

model BodyMeasurement {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String

  date       DateTime @default(now())
  weight     Float? // in kg
  bodyFat    Float? // percentage
  muscleMass Float? // in kg
  chest      Float? // in cm
  waist      Float? // in cm
  hips       Float? // in cm
  arms       Float? // in cm
  thighs     Float? // in cm

  createdAt DateTime @default(now())

  @@index([userId, date])
}

// ============================================
// NUTRITION
// ============================================

model MealPlan {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String

  name     String
  calories Int
  protein  Float // in grams
  carbs    Float // in grams
  fats     Float // in grams
  fiber    Float? // in grams

  meals Meal[]

  startDate DateTime
  endDate   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Meal {
  id         String   @id @default(cuid())
  mealPlan   MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  mealPlanId String

  name        String
  mealType    String // breakfast, lunch, dinner, snack
  calories    Int
  protein     Float
  carbs       Float
  fats        Float
  ingredients String[] // Grocery list items

  createdAt DateTime @default(now())
}

// ============================================
// COACHING
// ============================================

model CoachAssignment {
  id       String @id @default(cuid())
  coach    User   @relation("CoachAssignments", fields: [coachId], references: [id])
  coachId  String
  client   User   @relation("ClientAssignments", fields: [clientId], references: [id])
  clientId String

  assignedAt DateTime @default(now())
  status     String   @default("active")

  @@unique([coachId, clientId])
  @@index([coachId])
  @@index([clientId])
}

// ============================================
// COMMUNITY
// ============================================

model Group {
  id          String  @id @default(cuid())
  name        String
  description String?
  isPublic    Boolean @default(true)

  members    GroupMember[]
  challenges Challenge[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model GroupMember {
  id      String @id @default(cuid())
  group   Group  @relation(fields: [groupId], references: [id])
  groupId String
  user    User   @relation(fields: [userId], references: [id])
  userId  String

  role     String   @default("member") // member, admin
  joinedAt DateTime @default(now())

  @@unique([groupId, userId])
}

model Challenge {
  id      String  @id @default(cuid())
  group   Group?  @relation(fields: [groupId], references: [id])
  groupId String?

  name        String
  description String?
  startDate   DateTime
  endDate     DateTime
  goal        String? // e.g., "Complete 20 workouts"

  participants ChallengeParticipant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ChallengeParticipant {
  id          String    @id @default(cuid())
  challenge   Challenge @relation(fields: [challengeId], references: [id])
  challengeId String
  user        User      @relation(fields: [userId], references: [id])
  userId      String

  progress Int  @default(0)
  rank     Int?

  joinedAt DateTime @default(now())

  @@unique([challengeId, userId])
}

// ============================================
// EXISTING MODELS (Keep as is)
// ============================================

model CompletionLog {
  id               String   @id @default(cuid())
  client           Client   @relation(fields: [clientId], references: [id])
  clientId         String
  date             DateTime
  workoutCompleted Boolean  @default(false)
  habitsCompleted  String[] @db.Text

  createdAt DateTime @default(now())

  @@index([clientId, date])
}

model GamificationProfile {
  id             String    @id @default(cuid())
  client         Client    @relation(fields: [clientId], references: [id])
  clientId       String    @unique
  xp             Int       @default(0)
  level          Int       @default(1)
  streakDays     Int       @default(0)
  bestStreak     Int       @default(0)
  lastActiveDate DateTime?
  totalWorkouts  Int       @default(0)
  totalHabits    Int       @default(0)
  badges         String[]  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ChatMessage {
  id        String        @id @default(cuid())
  coach     User          @relation("CoachMessages", fields: [coachId], references: [id])
  coachId   String
  client    Client        @relation("ClientMessages", fields: [clientId], references: [id])
  clientId  String
  sender    MessageSender
  content   String
  readAt    DateTime?
  createdAt DateTime      @default(now())

  @@index([clientId, createdAt])
}

model CoachNote {
  id            String   @id @default(cuid())
  coach         User     @relation("CoachNotes", fields: [coachId], references: [id])
  coachId       String
  client        Client   @relation(fields: [clientId], references: [id])
  clientId      String
  message       String
  autoSuggested Boolean  @default(false)
  resolved      Boolean  @default(false)
  createdAt     DateTime @default(now())
}

model Notification {
  id        String           @id @default(cuid())
  client    Client           @relation(fields: [clientId], references: [id])
  clientId  String
  coach     User?            @relation("CoachNotifications", fields: [coachId], references: [id])
  coachId   String?
  type      NotificationType
  title     String
  body      String
  readAt    DateTime?
  createdAt DateTime         @default(now())
}

model ProgramTemplate {
  id          String             @id @default(cuid())
  name        String
  description String?
  goal        String?
  weeks       Int
  visibility  TemplateVisibility @default(PRIVATE)

  owner   User   @relation(fields: [ownerId], references: [id])
  ownerId String

  team   Team?   @relation(fields: [teamId], references: [id])
  teamId String?

  tags String[]
  slug String?  @unique

  days ProgramTemplateDay[]

  useCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProgramTemplateDay {
  id          String          @id @default(cuid())
  template    ProgramTemplate @relation(fields: [templateId], references: [id])
  templateId  String
  dayIndex    Int
  title       String
  workoutRole WorkoutRole
  isRestDay   Boolean         @default(false)
  notes       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([templateId, dayIndex])
}

model Team {
  id               String            @id @default(cuid())
  name             String
  owner            User              @relation("TeamOwner", fields: [ownerId], references: [id])
  ownerId          String
  members          TeamMember[]
  programTemplates ProgramTemplate[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TeamMember {
  id        String   @id @default(cuid())
  team      Team     @relation(fields: [teamId], references: [id])
  teamId    String
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  role      String   @default("COACH")
  createdAt DateTime @default(now())
}
